<div class="chat-messages">
  @for (message of messages; track message) {
  <div
    class="message-wrapper"
    [class.user]="message.sender === 'user'"
    [class.agent]="message.sender === 'agent' && !message.isSystem"
    [class.system]="message.isSystem"
  >
    <!-- Agent Avatar (Only for agent messages) -->
    @if (message.sender === 'agent' && !message.isSystem) {
    <div
      class="avatar"
      [style.background-image]="'url(' + getAgentAvatarUrl() + ')'"
    ></div>
    }
    <div class="message-content">
      @if (!message.isSystem) {
      <div class="sender-info">
        {{ message.sender === "user" ? "TÃº" : "Agente" }} â€¢
        {{ message.timestamp | date : "HH:mm" }}
      </div>
      }
      <!-- WhatsApp-Style Audio Message (for agent audio messages) -->
      @if (message.isAudioMessage && message.sender === 'agent') {
      <div class="audio-message-container">
        <button
          type="button"
          class="audio-player"
          (click)="toggleAudio.emit(message)"
        >
          <span class="material-symbols-outlined mic-icon">
            {{ message.audioPlaying ? "pause" : "play_arrow" }}
          </span>
          <div class="waveform" [class.playing]="message.audioPlaying">
            <span></span><span></span><span></span><span></span> <span></span
            ><span></span><span></span><span></span>
          </div>
          <span class="duration">{{ message.audioDuration || "0:03" }}</span>
        </button>
        <!-- Transcript removed - audio waveform is enough -->
      </div>
      }
      <!-- Regular text message (for non-audio or user messages) -->
      @if (!message.isAudioMessage || message.sender === 'user') {
      <div
        class="message-bubble"
        [class.user]="message.sender === 'user'"
        [class.agent]="message.sender === 'agent'"
        [class.system]="message.isSystem"
      >
        <p>{{ message.content }}</p>
      </div>
      }
    </div>
  </div>
  }

  <!-- Typing Indicator -->
  @if (isLoading) {
  <div class="message-wrapper agent">
    <div
      class="avatar"
      [style.background-image]="'url(' + getAgentAvatarUrl() + ')'"
    ></div>
    <div class="message-content">
      <div class="message-bubble agent">
        <div class="typing-indicator">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
    </div>
  </div>
  }
</div>
