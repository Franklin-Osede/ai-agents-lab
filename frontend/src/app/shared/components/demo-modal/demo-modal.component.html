<div class="modal-overlay" (click)="onClose()">
  <!-- Mobile Container mimicking the snippet -->
  <div class="mobile-container" (click)="$event.stopPropagation()">
      
      <!-- HEADER (Hidden on Step -1: Role Selector, Step 3: Professional Selection, Step 9: Payment) -->
      <header class="mobile-header" *ngIf="currentStep >= 0 && currentStep !== 3 && currentStep !== 9">
        <button class="icon-btn" (click)="currentStep > 0 ? prevStep() : onClose()">
            <span class="material-symbols-outlined">arrow_back_ios_new</span>
        </button>
        <div class="header-title">
            <h2>Agente de Reservas</h2>
            <div class="status-indicator">
                <span class="dot pulse"></span>
                <span class="status-text">En l√≠nea</span>
            </div>
        </div>
        <button class="icon-btn">
            <span class="material-symbols-outlined">call</span>
        </button>
      </header>

      <!-- MAIN CONTENT AREA SWITCHER -->
      <main class="mobile-main">
          
          <!-- LEAD CAPTURE MODAL (Shows after 3-5 interactions) -->
          <div class="lead-capture-overlay" *ngIf="showLeadCapture" (click)="showLeadCapture = false">
            <div class="lead-capture-modal" (click)="$event.stopPropagation()">
              <h3>¬øTe gust√≥ lo que viste? üéâ</h3>
              <p>Obt√©n tu API Key gratis para usar en tu negocio</p>
              <form (ngSubmit)="captureLead()">
                <input type="email" placeholder="Tu email" [(ngModel)]="leadEmail" name="email" required>
                <input type="text" placeholder="Tu nombre" [(ngModel)]="leadName" name="name" required>
                <div class="lead-capture-actions">
                  <button type="submit" class="btn-primary">Obtener API Key Gratis</button>
                  <button type="button" class="btn-secondary" (click)="showLeadCapture = false">Continuar Demo</button>
                </div>
              </form>
            </div>
          </div>

          <!-- STEP 1: PROFESSIONAL DASHBOARD (Legacy - not used in demo flow) -->
          <div class="step-view professional-dashboard-view" *ngIf="currentStep === -1">
            <!-- Header -->
            <div class="prof-header">
              <div class="prof-logo">
                <div class="logo-icon">
                  <span class="material-symbols-outlined">health_and_safety</span>
                </div>
                <span class="logo-text">MediConnect</span>
              </div>
              <div class="prof-actions">
                <!-- Logout Button -->
                <button class="icon-btn" (click)="onLogout()" title="Cerrar Sesi√≥n">
                    <span class="material-symbols-outlined" style="color: #ef4444;">logout</span>
                </button>
                <div class="profile-avatar">
                  <span class="material-symbols-outlined">person</span>
                </div>
              </div>
            </div>

            <!-- Main Content -->
            <div class="prof-content">
              <!-- Welcome Section -->
              <div class="welcome-section">
                <p class="section-label">Panel de Control</p>
                <h1 class="welcome-title">Hola, Dr. Ram√≠rez</h1>
              </div>

              <!-- Appointments Card -->
              <div class="appointments-card">
                <div class="card-header">
                  <div class="icon-badge blue">
                    <span class="material-symbols-outlined">calendar_today</span>
                  </div>
                  <span class="card-date">Hoy</span>
                </div>
                <div class="card-content">
                  <h2 class="card-number">6 Citas</h2>
                  <p class="card-subtitle">Tienes 2 citas pendientes de confirmar</p>
                  <button class="link-btn">
                    Ver agenda completa
                    <span class="material-symbols-outlined">arrow_forward</span>
                  </button>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="quick-actions">
                <div class="action-card">
                  <div class="icon-badge purple">
                    <span class="material-symbols-outlined">group</span>
                  </div>
                  <h3 class="action-title">Gestionar<br/>Pacientes</h3>
                </div>
                <div class="action-card">
                  <div class="icon-badge green">
                    <span class="material-symbols-outlined">trending_up</span>
                  </div>
                  <div class="badge-percent">+12%</div>
                  <h3 class="action-title">Estad√≠sticas<br/>Generales</h3>
                </div>
              </div>

              <!-- Access & Configuration -->
              <div class="config-section">
                <h3 class="section-title">Accesos y Configuraci√≥n</h3>
                
                <div class="config-list">
                  <div class="config-item">
                    <div class="config-icon">
                      <span class="material-symbols-outlined">settings</span>
                    </div>
                    <div class="config-info">
                      <h4 class="config-title">Configuraci√≥n</h4>
                      <p class="config-subtitle">Perfil, horarios y cuenta</p>
                    </div>
                    <span class="material-symbols-outlined arrow">chevron_right</span>
                  </div>

                  <div class="config-item">
                    <div class="config-icon avatar">
                      <span class="material-symbols-outlined">person</span>
                    </div>
                    <div class="config-info">
                      <h4 class="config-title">√öltima consulta</h4>
                      <p class="config-subtitle">Ana Garc√≠a ¬∑ Hace 2 horas</p>
                    </div>
                    <span class="material-symbols-outlined arrow">history</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="bottom-nav">
              <button class="nav-item active">
                <span class="material-symbols-outlined fill-1">home</span>
                <span class="nav-label">Inicio</span>
              </button>
              <button class="nav-item">
                <span class="material-symbols-outlined">calendar_today</span>
                <span class="nav-label">Agenda</span>
              </button>
              <button class="nav-item">
                <span class="material-symbols-outlined">chat</span>
                <span class="nav-label">Chat</span>
              </button>
              <button class="nav-item">
                <span class="material-symbols-outlined">person</span>
                <span class="nav-label">Perfil</span>
              </button>
            </div>
          </div>

          <!-- STEP 0: CLIENT PERSONAL DASHBOARD (Legacy - not used in demo flow) -->
          <div class="step-view client-dashboard-view" *ngIf="currentStep === -2">
            <!-- Header -->
            <div class="client-header">
              <div class="client-logo">
                <div class="logo-icon-client">
                  <span class="material-symbols-outlined">health_and_safety</span>
                </div>
                <span class="logo-text">MediConnect</span>
              </div>
              <div class="client-actions" style="display: flex; gap: 10px;">
                 <button class="icon-btn" (click)="onLogout()" title="Cerrar Sesi√≥n" style="border: none; background: none; cursor: pointer;">
                    <span class="material-symbols-outlined" style="color: #ef4444;">logout</span>
                </button>
                <div class="client-avatar">
                    <span class="material-symbols-outlined">person</span>
                </div>
              </div>
            </div>

            <!-- Main Content -->
            <div class="client-content">
              <!-- Welcome Section -->
              <div class="client-welcome">
                <h1 class="client-greeting">Hola, Mar√≠a üëã</h1>
                <p class="client-subtitle">Gestiona tu bienestar hoy.</p>
              </div>

              <!-- Book Appointment Card -->
              <div class="booking-card">
                <div class="booking-icon">
                  <span class="material-symbols-outlined">add</span>
                </div>
                <div class="booking-content">
                  <h2 class="booking-title">Reservar<br/>Nueva Cita</h2>
                  <p class="booking-subtitle">üîç Busca especialistas y horarios</p>
                </div>
                <button class="search-btn">
                  <span class="material-symbols-outlined">search</span>
                </button>
              </div>

              <!-- Next Visit -->
              <div class="next-visit-section">
                <div class="section-header">
                  <h3 class="section-title">Pr√≥xima Visita</h3>
                  <button class="see-all-btn">VER TODO</button>
                </div>

                <div class="appointment-card">
                  <div class="doctor-info">
                    <div class="doctor-avatar">
                      <span class="material-symbols-outlined">person</span>
                    </div>
                    <div class="doctor-details">
                      <h4 class="doctor-name">Dr. Carlos Mendoza</h4>
                      <p class="doctor-specialty">CARDIOLOG√çA</p>
                      <span class="status-badge confirmed">‚óè CONFIRMADA</span>
                    </div>
                    <button class="more-btn">
                      <span class="material-symbols-outlined">more_vert</span>
                    </button>
                  </div>
                  <div class="appointment-time">
                    <div class="time-item">
                      <span class="material-symbols-outlined">calendar_today</span>
                      <div>
                        <p class="time-label">FECHA</p>
                        <p class="time-value">15 Oct</p>
                      </div>
                    </div>
                    <div class="time-item">
                      <span class="material-symbols-outlined">schedule</span>
                      <div>
                        <p class="time-label">HORA</p>
                        <p class="time-value">09:30 AM</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Quick Access -->
              <div class="quick-access-section">
                <h3 class="section-title">Acceso R√°pido</h3>
                
                <div class="access-grid">
                  <div class="access-card">
                    <div class="access-icon blue">
                      <span class="material-symbols-outlined">calendar_month</span>
                    </div>
                    <h4 class="access-title">Mis Citas</h4>
                    <p class="access-subtitle">Historial y Futuras</p>
                  </div>

                  <div class="access-card">
                    <div class="access-icon purple">
                      <span class="material-symbols-outlined">person</span>
                    </div>
                    <h4 class="access-title">Mi Perfil</h4>
                    <p class="access-subtitle">Datos personales</p>
                  </div>

                  <div class="access-card">
                    <div class="access-icon orange">
                      <span class="material-symbols-outlined">notifications</span>
                    </div>
                    <h4 class="access-title">Avisos</h4>
                    <p class="access-subtitle">2 Nuevos</p>
                  </div>

                  <div class="access-card">
                    <div class="access-icon green">
                      <span class="material-symbols-outlined">support_agent</span>
                    </div>
                    <h4 class="access-title">Ayuda</h4>
                    <p class="access-subtitle">Soporte 24/7</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="bottom-nav">
              <button class="nav-item active">
                <span class="material-symbols-outlined fill-1">home</span>
                <span class="nav-label">Inicio</span>
              </button>
              <button class="nav-item">
                <span class="material-symbols-outlined">calendar_today</span>
                <span class="nav-label">Agenda</span>
              </button>
              <button class="nav-item">
                <span class="material-symbols-outlined">favorite</span>
                <span class="nav-label">Favs</span>
              </button>
              <button class="nav-item">
                <span class="material-symbols-outlined">person</span>
                <span class="nav-label">Perfil</span>
              </button>
            </div>

            <!-- Floating Action Button -->
            <button class="fab">
              <span class="material-symbols-outlined">add</span>
            </button>
          </div>
          
          <!-- STEP 1: CHAT (After Professional Selection) -->
          <div class="step-view chat-view" *ngIf="currentStep === 1">
              <!-- Calendar Modal Overlay -->
              <div class="calendar-modal-overlay" *ngIf="showCalendarModal" (click)="showCalendarModal = false">
                  <div class="calendar-modal-content" (click)="$event.stopPropagation()">
                      <div class="calendar-modal-header">
                          <h3>Selecciona Fecha y Hora</h3>
                          <button class="close-calendar-btn" (click)="showCalendarModal = false">
                              <span class="material-symbols-outlined">close</span>
                          </button>
                      </div>
                      <app-calendar 
                          [currentDate]="calendarData.currentDate"
                          [availableSlots]="availableSlots"
                          (slotSelected)="onSlotSelected($event)">
                      </app-calendar>
                  </div>
              </div>
               <!-- Timestamp -->
               <div class="chat-timestamp">
                   <span>Hoy</span>
               </div>
               
               <app-chat-interface
                  [messages]="messages"
                  [isLoading]="isLoading"
                ></app-chat-interface>
                
               <!-- Day Options Display (when agent offers days) -->
               <div class="day-options-panel" *ngIf="detectedDayOptions.length > 0">
                   <div class="day-options-header">
                       <span class="material-symbols-outlined">calendar_today</span>
                       <h4>Selecciona un d√≠a:</h4>
                   </div>
                   <div class="day-options-list">
                       <button 
                           *ngFor="let option of detectedDayOptions" 
                           class="day-option-button"
                           (click)="onDayOptionSelected(option)">
                           <span class="day-label">{{ option.label }}</span>
                           <span class="day-date">{{ option.date.getDate() }}/{{ option.date.getMonth() + 1 }}</span>
                       </button>
                   </div>
               </div>

               <!-- Real-time Availability Display -->
               <div class="availability-panel" *ngIf="availableSlots.length > 0 && !checkingAvailability">
                   <div class="availability-header">
                       <span class="material-symbols-outlined">schedule</span>
                       <h4>Horarios Disponibles (Tiempo Real)</h4>
                   </div>
                   <div class="availability-slots">
                       <button 
                           *ngFor="let slot of availableSlots" 
                           class="slot-button"
                           (click)="selectTimeSlot(slot)">
                           {{ slot }}
                       </button>
                   </div>
                   <button class="open-calendar-btn" (click)="openCalendarModal()">
                       <span class="material-symbols-outlined">calendar_today</span>
                       Ver calendario completo
                   </button>
               </div>
               
               <!-- Loading indicator for availability check -->
               <div class="availability-loading" *ngIf="checkingAvailability">
                   <span class="material-symbols-outlined spin">sync</span>
                   <span>Verificando disponibilidad en tiempo real...</span>
               </div>
               
               <!-- Button to open calendar if no availability shown yet -->
               <div class="calendar-cta" *ngIf="availableSlots.length === 0 && !checkingAvailability && messages.length > 2">
                   <button class="open-calendar-btn-large" (click)="openCalendarModal()">
                       <span class="material-symbols-outlined">calendar_today</span>
                       Ver Calendario de Disponibilidad
                   </button>
               </div>

               <!-- Restaurant Delivery Option Buttons (in chat) -->
               <div class="delivery-options" *ngIf="selectedRestaurant && selectedMenuType && !deliveryOption && messages.length > 0">
                   <button class="delivery-option-btn dine-in" (click)="selectDeliveryOption('dine-in')">
                       <span class="material-symbols-outlined">restaurant</span>
                       <div>
                           <strong>Comer Aqu√≠</strong>
                           <span>Reservar mesa en el restaurante</span>
                       </div>
                   </button>
                   <button class="delivery-option-btn delivery" (click)="selectDeliveryOption('delivery')">
                       <span class="material-symbols-outlined">delivery_dining</span>
                       <div>
                           <strong>Pedir a Domicilio</strong>
                           <span>Entrega en tu direcci√≥n</span>
                       </div>
                   </button>
               </div>
          </div>

          <!-- STEP 2: CALENDAR (Shows when agent checks availability) -->
          <div class="step-view calendar-view" *ngIf="currentStep === 2">
              <div class="step-header">
                  <h3>üìÖ Horarios Disponibles</h3>
                  <p class="step-subtitle" *ngIf="selectedService">
                      Para {{selectedService.name}} - Selecciona fecha y hora
                  </p>
              </div>
              
              <!-- Show available slots from agent check -->
              <div class="availability-display" *ngIf="availableSlots.length > 0">
                  <p class="availability-info">
                      El agente ha verificado la disponibilidad. Estos son los horarios disponibles:
                  </p>
                  <div class="slots-grid">
                      <button 
                          *ngFor="let slot of availableSlots" 
                          class="slot-btn"
                          (click)="selectTimeSlot(slot)">
                          {{ slot }}
                      </button>
                  </div>
              </div>
              
              <app-calendar 
                  [currentDate]="calendarData.currentDate"
                  [availableSlots]="availableSlots"
                  (slotSelected)="onSlotSelected($event)">
              </app-calendar>
          </div>

          <!-- STEP 3: PROFESSIONAL SELECTION (Based on provided HTML design) -->
          <div class="step-view professional-view-new" 
               *ngIf="currentStep === 3"
               [style.--filter-active-bg]="getCategoryColor()"
               [style.--filter-active-bg-hover]="getCategoryColorHover()"
               [style.--professional-title-color]="getCategoryColor()">
              <!-- Header -->
              <div class="professional-header">
                  <button class="back-btn" (click)="goToStep(0)">
                      <span class="material-symbols-outlined">arrow_back_ios_new</span>
                  </button>
                  <h2>Elige tu Experto</h2>
              </div>
              
              <!-- Filter Chips -->
              <div class="filter-chips">
                  <button 
                      class="filter-chip active" 
                      [class.active]="selectedFilter === 'best-rated'"
                      (click)="selectedFilter = 'best-rated'">
                      <span class="material-symbols-outlined">star</span>
                      <p>Mejor Valorados</p>
                  </button>
                  <button 
                      class="filter-chip" 
                      [class.active]="selectedFilter === 'nearest'"
                      (click)="selectedFilter = 'nearest'">
                      <span class="material-symbols-outlined">location_on</span>
                      <p>M√°s Cercanos</p>
                  </button>
                  <button 
                      class="filter-chip" 
                      [class.active]="selectedFilter === 'price-low'"
                      (click)="selectedFilter = 'price-low'">
                      <span class="material-symbols-outlined">attach_money</span>
                      <p>Precio Bajo</p>
                  </button>
                  <button 
                      class="filter-chip" 
                      [class.active]="selectedFilter === 'availability'"
                      (click)="selectedFilter = 'availability'">
                      <span class="material-symbols-outlined">calendar_today</span>
                      <p>Disponibilidad</p>
                  </button>
                          </div>

              <!-- Professional List -->
              <div class="professionals-list">
                  <!-- Dynamic Professional Cards -->
                  <div class="professional-card" *ngFor="let prof of getProfessionalsForService()">
                      <div class="professional-main">
                          <div class="professional-avatar" 
                               [style.background-image]="'url(' + prof.image + ')'">
                      </div>
                          <div class="professional-info">
                              <div class="professional-header-info">
                                  <div>
                                      <h3>{{ prof.name }}</h3>
                                      <p class="professional-title">{{ prof.title }}</p>
                  </div>
                                  <div class="rating-badge">
                                      <span class="material-symbols-outlined filled">star</span>
                                      <span>{{ prof.rating }}</span>
                          </div>
                      </div>
                              <p class="professional-description">
                                  {{ prof.description }}
                              </p>
                          </div>
                      </div>
                      <div class="professional-footer">
                          <span class="professional-meta">{{ prof.reviews }} Rese√±as ‚Ä¢ A {{ prof.distance }}</span>
                          <button class="select-btn" (click)="selectProfessional({
                              name: prof.name,
                              image: prof.image,
                              title: prof.title,
                              rating: prof.rating,
                              reviews: prof.reviews
                          })">
                              Seleccionar
                          </button>
                      </div>
                  </div>
              </div>
          </div>

          <!-- STEP 0: SERVICE SELECTOR (First step for demo) -->
          <div class="step-view service-selection-view" *ngIf="currentStep === 0">
              <app-service-selector 
                  (serviceSelected)="onServiceSelected($event)"
                  (back)="onServiceSelectorBack()">
              </app-service-selector>
          </div>

          <!-- STEP 3.5: SERVICE SELECTION (Legacy - for booking flow) -->
          <div class="step-view service-selection-view" *ngIf="currentStep === 3.5">
              <app-service-selector 
                  (serviceSelected)="onServiceSelected($event)"
                  (back)="onServiceSelectorBack()">
              </app-service-selector>
          </div>

          <!-- STEP 4: CONFIRMATION (Based on provided HTML design) -->
          <!-- STEP 9: PAYMENT -->
          <div class="step-view payment-view" *ngIf="currentStep === 9">
              <!-- Top App Bar -->
              <div class="payment-header">
                  <button class="back-btn" (click)="goToStep(2)">
                      <span class="material-symbols-outlined">arrow_back_ios_new</span>
                  </button>
                  <h2>Pago</h2>
               </div>
               
              <!-- Main Content - Sin contenedor scrollable, todo en una pantalla -->
              <div class="payment-content">
                  <!-- Test Environment Banner -->
                  <div class="test-banner">
                      <div class="test-banner-content">
                          <span class="material-symbols-outlined">science</span>
                          <div class="test-banner-text">
                              <p class="test-banner-title">Entorno de Prueba</p>
                              <p class="test-banner-message">No se realizar√° ning√∫n cobro real. Esta es una simulaci√≥n para demostraci√≥n.</p>
                          </div>
                      </div>
                   </div>
                   
                  <!-- Booking Summary - Sin div separado, directamente en el fondo -->
                  <div class="booking-summary-section">
                      <h3>Resumen de la Reserva</h3>
                      <div class="summary-item">
                          <span class="summary-label">Servicio:</span>
                          <span class="summary-value">{{ selectedService?.name || 'Servicio' }}</span>
                       </div>
                      <div class="summary-item" *ngIf="selectedProfessionalData">
                          <span class="summary-label">Profesional:</span>
                          <span class="summary-value">{{ selectedProfessionalData.name }}</span>
                      </div>
                      <div class="summary-item" *ngIf="selectedRestaurant">
                          <span class="summary-label">Restaurante:</span>
                          <span class="summary-value">{{ selectedRestaurant.name }}</span>
                      </div>
                      <div class="summary-item">
                          <span class="summary-label">Fecha:</span>
                          <span class="summary-value">{{ calendarData.currentDate | date:'EEEE, d \'de\' MMMM' | titlecase }}</span>
                      </div>
                      <div class="summary-item">
                          <span class="summary-label">Hora:</span>
                          <span class="summary-value">{{ calendarData.selectedSlot }}</span>
                      </div>
                      <div class="summary-item total">
                          <span class="summary-label">Total:</span>
                          <span class="summary-value">‚Ç¨{{ getBookingPrice() }}.00</span>
                      </div>
                   </div>
                   
                  <!-- Payment Method - Sin div separado, directamente en el fondo -->
                  <div class="payment-method-section">
                      <h3>M√©todo de Pago</h3>
                      <div class="stripe-container">
                          <!-- Stripe Elements will be injected here -->
                          <div class="stripe-placeholder" *ngIf="!paymentProcessing && !paymentError">
                              <div class="card-element-placeholder">
                                  <div class="card-icon-wrapper">
                                      <span class="material-symbols-outlined">credit_card</span>
                           </div>
                                  <p class="stripe-label">Pago seguro con Stripe</p>
                                  <div class="test-card-info">
                                      <span class="material-symbols-outlined">info</span>
                                      <p>Modo de prueba: Usa la tarjeta de prueba <strong>4242 4242 4242 4242</strong></p>
                       </div>
                           </div>
                       </div>
                          <div class="payment-loading" *ngIf="paymentProcessing">
                              <div class="spinner"></div>
                              <p>Procesando pago...</p>
                           </div>
                          <div class="payment-error" *ngIf="paymentError">
                              <span class="material-symbols-outlined">error</span>
                              <p>{{ paymentError }}</p>
                       </div>
                           </div>
                       </div>

                  <!-- Security Notice -->
                  <div class="security-notice">
                      <span class="material-symbols-outlined">verified</span>
                      <p>Tu informaci√≥n est√° protegida. Este es un entorno de prueba y no se procesar√°n pagos reales.</p>
                   </div>
                   
                  <!-- Payment Button - Dentro del contenido, sticky al final -->
                  <div class="payment-actions">
                      <button 
                          class="pay-button" 
                          [disabled]="paymentProcessing"
                          (click)="initializePayment()"
                          *ngIf="!paymentProcessing && !paymentError">
                          <span class="material-symbols-outlined">lock</span>
                          <span>Pagar ‚Ç¨{{ getBookingPrice() }}.00</span>
                          <span class="test-badge">PRUEBA</span>
                      </button>
                      <button 
                          class="pay-button retry-button" 
                          [disabled]="paymentProcessing"
                          (click)="initializePayment()"
                          *ngIf="paymentError">
                          <span class="material-symbols-outlined">refresh</span>
                          Reintentar Pago
                      </button>
                       </div>
                       </div>
          </div>

          <div class="step-view confirmation-view-new" *ngIf="currentStep === 4">
              <!-- Top App Bar -->
              <div class="confirmation-header">
                  <button class="back-btn" (click)="goToStep(1)">
                      <span class="material-symbols-outlined">arrow_back_ios_new</span>
                  </button>
                  <h2>Detalles de la Cita</h2>
               </div>
               
              <!-- Main Content - Sin contenedor scrollable, todo en una pantalla -->
              <div class="confirmation-content">
                  <!-- Status Card -->
                  <div class="status-card">
                      <div class="status-icon-wrapper">
                          <span class="material-symbols-outlined status-icon">check</span>
                      </div>
                      <h3>Reservaci√≥n Confirmada</h3>
                      <p>Tu cita ha sido programada exitosamente.</p>
                      <div class="add-calendar-btn-wrapper">
                          <button class="add-calendar-btn" (click)="addToCalendar()">
                              <span class="material-symbols-outlined">calendar_add_on</span>
                              A√±adir a Calendario
                          </button>
                      </div>
                   </div>
                   
                  <!-- Details List -->
                  <div class="details-section">
                      <h4>Informaci√≥n</h4>
                      <div class="details-list">
                          <!-- Date -->
                          <div class="detail-row">
                              <div class="detail-icon">
                                  <span class="material-symbols-outlined">calendar_today</span>
                       </div>
                              <div class="detail-content">
                                  <p class="detail-label">Fecha</p>
                                  <p class="detail-value">{{ calendarData.currentDate | date:'EEEE, d \'de\' MMMM' | titlecase }}</p>
                              </div>
                   </div>
                   
                          <!-- Time -->
                          <div class="detail-row">
                              <div class="detail-icon">
                                  <span class="material-symbols-outlined">schedule</span>
                           </div>
                              <div class="detail-content">
                                  <p class="detail-label">Hora</p>
                                  <p class="detail-value">{{ calendarData.selectedSlot || '10:00' }} - {{ getEndTime(calendarData.selectedSlot || '10:00') }} <span class="duration">(1h)</span></p>
                       </div>
                           </div>

                          <!-- Service / Restaurant -->
                          <div class="detail-row" *ngIf="!selectedRestaurant">
                              <div class="detail-icon">
                                  <span class="material-symbols-outlined">content_cut</span>
                       </div>
                              <div class="detail-content">
                                  <p class="detail-label">Servicio</p>
                                  <p class="detail-value">{{ selectedService?.name || 'Corte de Cabello y Barba' }}</p>
                           </div>
                       </div>
                          <div class="detail-row" *ngIf="selectedRestaurant">
                              <div class="detail-icon">
                                  <span class="material-symbols-outlined">restaurant</span>
                           </div>
                              <div class="detail-content">
                                  <p class="detail-label">Restaurante</p>
                                  <p class="detail-value">{{ selectedRestaurant.name }}</p>
                              </div>
                          </div>
                          <div class="detail-row" *ngIf="selectedRestaurant && selectedMenuType">
                              <div class="detail-icon">
                                  <span class="material-symbols-outlined">restaurant_menu</span>
                              </div>
                              <div class="detail-content">
                                  <p class="detail-label">Tipo de Men√∫</p>
                                  <p class="detail-value">{{ getSelectedMenuTypeName() }}</p>
                       </div>
                   </div>
                   
                          <!-- Professional -->
                          <div class="detail-row" *ngIf="selectedProfessionalData">
                              <div class="detail-icon professional-avatar">
                                  <img *ngIf="selectedProfessionalData.image" [src]="selectedProfessionalData.image" [alt]="selectedProfessionalData.name + ' profile'">
                                  <span *ngIf="!selectedProfessionalData.image" class="material-symbols-outlined">person</span>
                       </div>
                              <div class="detail-content">
                                  <p class="detail-label">Profesional</p>
                                  <p class="detail-value">{{ selectedProfessionalData.name || selectedProfessional || 'Profesional Asignado' }}</p>
                       </div>
                          </div>
                          <div class="detail-row" *ngIf="!selectedProfessionalData">
                              <div class="detail-icon professional-avatar">
                                  <span class="material-symbols-outlined">person</span>
                              </div>
                              <div class="detail-content">
                                  <p class="detail-label">Profesional</p>
                                  <p class="detail-value">{{ selectedProfessional || 'Profesional Asignado' }}</p>
                              </div>
                          </div>

                          <!-- Cost -->
                          <div class="detail-row cost-row">
                              <div class="detail-icon cost-icon">
                                  <span class="material-symbols-outlined">payments</span>
                              </div>
                              <div class="detail-content cost-content">
                                  <div class="cost-header">
                                      <p class="detail-label">Costo Total</p>
                                      <span class="paid-badge">Pagado</span>
                                  </div>
                                  <p class="cost-value">‚Ç¨{{ getBookingPrice() }}.00</p>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- Location Section -->
                  <div class="location-section">
                      <h4>Ubicaci√≥n</h4>
                      <div class="location-card">
                          <div class="location-map">
                              <div class="map-placeholder">
                                  <div class="map-marker">
                                      <span class="material-symbols-outlined">storefront</span>
                                  </div>
                              </div>
                          </div>
                              <div class="location-info">
                              <div>
                                  <p class="location-name">{{ selectedRestaurant?.name || selectedService?.name || 'Barber√≠a The Gentlemen' }}</p>
                                  <p class="location-address" *ngIf="deliveryAddress">{{ deliveryAddress.formatted_address }}</p>
                                  <p class="location-address" *ngIf="!deliveryAddress">Av. Reforma 222, CDMX</p>
                              </div>
                              <button class="location-btn">
                                  <span class="material-symbols-outlined">near_me</span>
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Bottom Action Bar - Dentro del contenido, sticky al final -->
                  <div class="confirmation-actions">
                      <button class="reschedule-btn" (click)="rescheduleBooking()">
                          Reagendar
                      </button>
                      <button class="cancel-btn" (click)="cancelBooking()">
                          Cancelar Cita
                      </button>
                  </div>
              </div>
          </div>

          <!-- STEP 6: RESTAURANT SELECTION -->
          <div class="step-view restaurant-selection-view" *ngIf="currentStep === 6">
              <div class="restaurant-header">
                  <button class="back-btn" (click)="goToStep(0)">
                      <span class="material-symbols-outlined">arrow_back_ios_new</span>
                  </button>
                  <h2>Elige un Restaurante</h2>
              </div>

              <div class="restaurants-list">
                  <div class="restaurant-card" *ngFor="let restaurant of getRestaurants()" (click)="selectRestaurant(restaurant)">
                      <div class="restaurant-image" [style.background-image]="'url(' + restaurant.image + ')'"></div>
                      <div class="restaurant-info">
                          <div class="restaurant-header-info">
                              <div>
                                  <h3>{{ restaurant.name }}</h3>
                                  <p class="restaurant-cuisine">{{ restaurant.cuisine }}</p>
                              </div>
                              <div class="rating-badge">
                                  <span class="material-symbols-outlined filled">star</span>
                                  <span>{{ restaurant.rating }}</span>
                              </div>
                          </div>
                      </div>
                      <div class="restaurant-footer">
                          <span class="restaurant-meta">{{ restaurant.reviews }} Rese√±as ‚Ä¢ A {{ restaurant.distance }}</span>
                       <span class="material-symbols-outlined arrow">chevron_right</span>
                      </div>
                  </div>
              </div>
                   </div>
                   
          <!-- STEP 7: MENU TYPE SELECTION -->
          <div class="step-view menu-selection-view" *ngIf="currentStep === 7">
              <div class="menu-header">
                  <button class="back-btn" (click)="goToStep(6)">
                      <span class="material-symbols-outlined">arrow_back_ios_new</span>
                  </button>
                  <h2>Elige Tipo de Men√∫</h2>
                  <p class="restaurant-name" *ngIf="selectedRestaurant">{{ selectedRestaurant.name }}</p>
              </div>

              <div class="menu-types-list">
                  <div class="menu-type-card" *ngFor="let menuType of getMenuTypes()" (click)="selectMenuType(menuType.id)">
                      <div class="menu-icon">
                          <span class="material-symbols-outlined">{{ menuType.icon }}</span>
                      </div>
                      <div class="menu-info">
                          <h3>{{ menuType.name }}</h3>
                          <p>{{ menuType.description }}</p>
                      </div>
                      <span class="material-symbols-outlined arrow">chevron_right</span>
                  </div>
              </div>
          </div>
                   
          <!-- STEP 8: DELIVERY ADDRESS SELECTION -->
          <div class="step-view delivery-address-view" *ngIf="currentStep === 8">
              <div class="delivery-header">
                  <button class="back-btn" (click)="goToStep(1)">
                      <span class="material-symbols-outlined">arrow_back_ios_new</span>
                       </button>
                  <h2>Direcci√≥n de Entrega</h2>
                  <p class="delivery-subtitle">Selecciona la direcci√≥n donde quieres recibir tu pedido</p>
                   </div>

              <div class="delivery-content">
                  <app-google-maps-autocomplete
                      [placeholder]="'Buscar direcci√≥n de entrega...'"
                      [label]="'Direcci√≥n de Entrega'"
                      (placeSelected)="onAddressSelected($event)">
                  </app-google-maps-autocomplete>

                  <div class="delivery-info" *ngIf="deliveryAddress">
                      <div class="info-card">
                          <span class="material-symbols-outlined">location_on</span>
                          <div>
                              <p class="info-label">Direcci√≥n confirmada</p>
                              <p class="info-value">{{ deliveryAddress.formatted_address }}</p>
                          </div>
                      </div>
                  </div>

                  <div class="delivery-actions" *ngIf="deliveryAddress">
                      <button class="continue-btn" (click)="goToStep(2)">
                          Continuar con la Reserva
                          <span class="material-symbols-outlined">arrow_forward</span>
                      </button>
                  </div>
              </div>
          </div>

          <!-- STEP 5: SUCCESS MESSAGE -->
          <div class="step-view success-view" *ngIf="currentStep === 5 && showSuccessMessage">
              <div class="success-container">
                  <div class="success-icon">
                      <span class="material-symbols-outlined">check_circle</span>
                  </div>
                  <h2 class="success-title">¬°Cita Confirmada!</h2>
                  <p class="success-message">
                      Tu cita ha sido confirmada exitosamente. Recibir√°s un recordatorio antes de tu cita.
                  </p>
                  
                  <div class="success-details">
                      <div class="detail-row">
                          <span class="material-symbols-outlined">person</span>
                          <span>{{ selectedProfessional || 'Profesional Asignado' }}</span>
                      </div>
                      <div class="detail-row">
                          <span class="material-symbols-outlined">calendar_today</span>
                          <span>{{ calendarData.currentDate | date:'EEEE, d MMMM' | titlecase }}</span>
                      </div>
                      <div class="detail-row">
                          <span class="material-symbols-outlined">schedule</span>
                          <span>{{ calendarData.selectedSlot || '10:00' }}</span>
                      </div>
                      <div class="detail-row">
                          <span class="material-symbols-outlined">spa</span>
                          <span>{{ selectedService?.name || 'Servicio' }}</span>
                      </div>
                  </div>
                  
                  <button class="success-btn" (click)="onSuccessClose()">
                      Cerrar
                  </button>
               </div>
          </div>
      </main>

      <!-- BOTTOM INPUT AREA (Only on Chat Step 1) -->
      <div class="mobile-footer" *ngIf="currentStep === 1">
          <!-- Chips -->
          <div class="chips-scroll" *ngIf="exampleMessages.length > 0 && detectedDayOptions.length === 0">
              <button *ngFor="let ex of exampleMessages" class="chip" (click)="useExample(ex)">
                  {{ ex }}
              </button>
          </div>

          <!-- Input Bar -->
          <div class="input-bar">
              <button class="icon-btn-small">
                  <span class="material-symbols-outlined">add_circle</span>
              </button>
              <div class="input-wrapper">
                  <input 
                      type="text" 
                      [(ngModel)]="currentMessage" 
                      (keypress)="onKeyPress($event)"
                      placeholder="Escribe un mensaje..."
                  >
                  <button class="emoji-btn">
                      <span class="material-symbols-outlined">sentiment_satisfied</span>
                  </button>
              </div>
              <button 
                  class="send-btn-circle" 
                  [disabled]="!currentMessage.trim()"
                  (click)="sendMessage()">
                  <span class="material-symbols-outlined">send</span>
              </button>
          </div>

          <!-- STEP 4: BOOKING CONFIRMATION -->
          <div class="step-view booking-confirmation-view" *ngIf="isStep(4) && selectedBooking">
              <div class="confirmation-header">
                  <button class="icon-btn" (click)="navigateToTab('inicio')">
                      <span class="material-symbols-outlined">arrow_back_ios_new</span>
                  </button>
                  <h2>Detalles de la Cita</h2>
              </div>

              <div class="confirmation-content">
                  <!-- Status Card -->
                  <div class="status-card">
                      <div class="status-icon">
                          <span class="material-symbols-outlined">check</span>
                      </div>
                      <h3>Reservaci√≥n Confirmada</h3>
                      <p>Tu cita ha sido programada exitosamente.</p>
                      <button class="btn-add-calendar" (click)="addToCalendar()">
                          <span class="material-symbols-outlined">calendar_add_on</span>
                          A√±adir a Calendario
                      </button>
                  </div>

                  <!-- Details List -->
                  <div class="details-section">
                      <h4>Informaci√≥n</h4>
                      <div class="details-card">
                          <div class="detail-item">
                              <div class="detail-icon">
                                  <span class="material-symbols-outlined">calendar_today</span>
                              </div>
                              <div>
                                  <p class="detail-label">Fecha</p>
                                  <p class="detail-value">{{ formatDate(selectedBooking.date) }}</p>
                              </div>
                          </div>
                          <div class="detail-item">
                              <div class="detail-icon">
                                  <span class="material-symbols-outlined">schedule</span>
                              </div>
                              <div>
                                  <p class="detail-label">Hora</p>
                                  <p class="detail-value">{{ selectedBooking.time }} - {{ getEndTime(selectedBooking.time) }} (1h)</p>
                              </div>
                          </div>
                          <div class="detail-item">
                              <div class="detail-icon">
                                  <span class="material-symbols-outlined">content_cut</span>
                              </div>
                              <div>
                                  <p class="detail-label">Servicio</p>
                                  <p class="detail-value">{{ selectedBooking.service }}</p>
                              </div>
                          </div>
                          <div class="detail-item">
                              <div class="detail-icon">
                                  <span class="material-symbols-outlined">person</span>
                              </div>
                              <div>
                                  <p class="detail-label">Profesional</p>
                                  <p class="detail-value">{{ selectedBooking.professional }}</p>
                              </div>
                          </div>
                          <div class="detail-item payment-item" *ngIf="selectedBooking.amount">
                              <div class="detail-icon payment-icon">
                                  <span class="material-symbols-outlined">payments</span>
                              </div>
                              <div class="flex-1">
                                  <div class="flex justify-between items-center mb-1">
                                      <p class="detail-label">Costo Total</p>
                                      <span class="payment-badge" [class.paid]="selectedBooking.paymentStatus === 'paid'">
                                          {{ selectedBooking.paymentStatus === 'paid' ? 'Pagado' : 'Pendiente' }}
                                      </span>
                                  </div>
                                  <p class="detail-value price">${{ selectedBooking.amount.toFixed(2) }} MXN</p>
                                  <button 
                                      *ngIf="selectedBooking.paymentStatus === 'pending'"
                                      class="btn-pay-test" 
                                      (click)="processTestPayment(selectedBooking.id, selectedBooking.amount)">
                                      Pagar con Dinero de Prueba
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Bottom Actions -->
              <div class="bottom-actions">
                  <button class="btn-secondary" (click)="reagendarBooking(selectedBooking.id)">Reagendar</button>
                  <button class="btn-danger" (click)="cancelBookingById(selectedBooking.id)">Cancelar Cita</button>
              </div>
          </div>

          <!-- STEP 10: RESERVAS VIEW -->
          <div class="step-view reservas-view" *ngIf="isStep(10)">
              <div class="reservas-header">
                  <button class="icon-btn" (click)="navigateToTab('inicio')">
                      <span class="material-symbols-outlined">arrow_back_ios_new</span>
                  </button>
                  <h2>Mis Reservas</h2>
              </div>

              <div class="reservas-content">
                  <div *ngIf="bookings.length === 0" class="empty-reservas">
                      <span class="material-symbols-outlined">calendar_today</span>
                      <p>No tienes reservas a√∫n</p>
                  </div>

                  <div *ngFor="let booking of bookings" class="booking-card">
                      <div class="booking-info">
                          <div class="booking-date-time">
                              <span class="material-symbols-outlined">event</span>
                              <div>
                                  <p class="booking-date">{{ formatDate(booking.date) }}</p>
                                  <p class="booking-time">{{ booking.time }}</p>
                              </div>
                          </div>
                          <div class="booking-details">
                              <p class="booking-service">{{ booking.service }}</p>
                              <p class="booking-professional" *ngIf="booking.professional">{{ booking.professional }}</p>
                          </div>
                          <div class="booking-status">
                              <span class="status-badge" [class.confirmed]="booking.status === 'confirmed'" 
                                    [class.cancelled]="booking.status === 'cancelled'">
                                  {{ booking.status === 'confirmed' ? 'Confirmada' : booking.status === 'cancelled' ? 'Cancelada' : 'Pendiente' }}
                              </span>
                          </div>
                      </div>
                      <div class="booking-actions">
                          <button class="btn-view" (click)="viewBookingDetails(booking)">Ver Detalles</button>
                          <button class="btn-cancel" (click)="cancelBookingById(booking.id)" *ngIf="booking.status === 'confirmed'">Cancelar</button>
                          <button class="btn-delete" (click)="deleteBooking(booking.id)">Eliminar</button>
                      </div>
                  </div>
              </div>
          </div>

          <!-- STEP 11: AVISOS VIEW -->
          <div class="step-view avisos-view" *ngIf="isStep(11)">
              <div class="avisos-header">
                  <button class="icon-btn" (click)="navigateToTab('inicio')">
                      <span class="material-symbols-outlined">arrow_back_ios_new</span>
                  </button>
                  <div class="header-title-group">
                      <span class="material-symbols-outlined filled">notifications</span>
                      <h2>Avisos</h2>
                      <div class="badge-unread" *ngIf="unreadNotificationsCount > 0">
                          <span class="dot-pulse"></span>
                          {{ unreadNotificationsCount }}
                      </div>
                  </div>
                  <button class="btn-mark-read" (click)="markAllNotificationsAsRead()">Le√≠dos</button>
              </div>

              <div class="avisos-content">
                  <div *ngIf="notifications.length === 0" class="empty-avisos">
                      <div class="empty-icon-wrapper">
                          <span class="material-symbols-outlined">inbox</span>
                      </div>
                      <p>No tienes m√°s avisos para mostrar.</p>
                  </div>

                  <!-- Group by date -->
                  <div *ngFor="let group of getNotificationGroups()" class="notification-group">
                      <h3 class="group-header">
                          <span>{{ group.label }}</span>
                          <div class="divider-line"></div>
                      </h3>

                      <div *ngFor="let notif of group.notifications" 
                           class="notification-card" 
                           [class.read]="notif.read"
                           (click)="markNotificationAsRead(notif.id)">
                          <div class="notification-dot" *ngIf="!notif.read"></div>
                          <div class="notification-icon" [ngClass]="'icon-' + notif.color">
                              <span class="material-symbols-outlined">{{ notif.icon }}</span>
                          </div>
                          <div class="notification-content">
                              <h4>{{ notif.title }}</h4>
                              <p>{{ notif.message }}</p>
                              <span class="notification-time">
                                  <span class="material-symbols-outlined">schedule</span>
                                  {{ getRelativeTime(notif.timestamp) }}
                              </span>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- Bottom Navigation (Fixed) -->
      <nav class="bottom-nav-fixed" *ngIf="currentStep >= 0 && currentStep < 10">
          <button class="nav-item" [class.active]="activeTab === 'inicio'" (click)="navigateToTab('inicio')">
              <span class="material-symbols-outlined" [class.filled]="activeTab === 'inicio'">home</span>
              <span class="nav-text">Inicio</span>
          </button>
          <button class="nav-item" [class.active]="activeTab === 'reservas'" (click)="navigateToTab('reservas')">
              <span class="material-symbols-outlined" [class.filled]="activeTab === 'reservas'">calendar_today</span>
              <span class="nav-text">Reservas</span>
          </button>
          <div class="nav-spacer"></div>
          <button class="nav-item" [class.active]="activeTab === 'avisos'" (click)="navigateToTab('avisos')">
              <span class="material-symbols-outlined" [class.filled]="activeTab === 'avisos'">notifications</span>
              <span class="nav-text">Avisos</span>
              <span class="nav-badge" *ngIf="unreadNotificationsCount > 0">{{ unreadNotificationsCount }}</span>
          </button>
          <button class="nav-item" [class.active]="activeTab === 'perfil'" (click)="navigateToTab('perfil')">
              <span class="material-symbols-outlined" [class.filled]="activeTab === 'perfil'">person</span>
              <span class="nav-text">Perfil</span>
          </button>
      </nav>

  </div>
</div>
